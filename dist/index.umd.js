!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).MxBankTransactionParser={})}(this,function(e){"use strict";class t{constructor({date:e,type:t,amount:i,balance:r,description:n,reference:o,bank:s,accountNumber:a=null,beneficiary:l=null,trackingKey:c=null,extra:f=""}){this.date=e,this.type=t,this.amount=i,this.balance=r,this.description=n,this.reference=o,this.bank=s,this.accountNumber=a,this.beneficiary=l,this.trackingKey=c,this.extra=f}}class i extends Error{constructor(e,t,r,...n){Array.isArray(t)&&(t=t.join(" ").trim()),super(t),void 0!==Error.captureStackTrace&&Error.captureStackTrace(this,i),this.code=e;for(const e of n)for(const t in e){const i=e[t];this[t]=Buffer.isBuffer(i)?i.toString(r.encoding):null==i?i:JSON.parse(JSON.stringify(i))}}}const r=function(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)},n=function(e){const t=[];for(let n=0,o=e.length;n<o;n++){const o=e[n];if(null==o||!1===o)t[n]={disabled:!0};else if("string"==typeof o)t[n]={name:o};else{if(!r(o))throw new i("CSV_INVALID_COLUMN_DEFINITION",["Invalid column definition:","expect a string or a literal object,",`got ${JSON.stringify(o)} at position ${n}`]);if("string"!=typeof o.name)throw new i("CSV_OPTION_COLUMNS_MISSING_NAME",["Option columns missing name:",`property "name" is required at position ${n}`,"when column is an object literal"]);t[n]=o}}return t};class o{constructor(e=100){this.size=e,this.length=0,this.buf=Buffer.allocUnsafe(e)}prepend(e){if(Buffer.isBuffer(e)){const t=this.length+e.length;if(t>=this.size&&(this.resize(),t>=this.size))throw Error("INVALID_BUFFER_STATE");const i=this.buf;this.buf=Buffer.allocUnsafe(this.size),e.copy(this.buf,0),i.copy(this.buf,e.length),this.length+=e.length}else{const t=this.length++;t===this.size&&this.resize();const i=this.clone();this.buf[0]=e,i.copy(this.buf,1,0,t)}}append(e){const t=this.length++;t===this.size&&this.resize(),this.buf[t]=e}clone(){return Buffer.from(this.buf.slice(0,this.length))}resize(){const e=this.length;this.size=2*this.size;const t=Buffer.allocUnsafe(this.size);this.buf.copy(t,0,0,e),this.buf=t}toString(e){return e?this.buf.slice(0,this.length).toString(e):Uint8Array.prototype.slice.call(this.buf.slice(0,this.length))}toJSON(){return this.toString("utf8")}reset(){this.length=0}}const s=function(e){return{bomSkipped:!1,bufBytesStart:0,castField:e.cast_function,commenting:!1,error:void 0,enabled:1===e.from_line,escaping:!1,escapeIsQuote:Buffer.isBuffer(e.escape)&&Buffer.isBuffer(e.quote)&&0===Buffer.compare(e.escape,e.quote),expectedRecordLength:Array.isArray(e.columns)?e.columns.length:void 0,field:new o(20),firstLineToHeaders:e.cast_first_line_to_header,needMoreDataSize:Math.max(null!==e.comment?e.comment.length:0,...e.delimiter.map(e=>e.length),null!==e.quote?e.quote.length:0),previousBuf:void 0,quoting:!1,stop:!1,rawBuffer:new o(100),record:[],recordHasError:!1,record_length:0,recordDelimiterMaxLength:0===e.record_delimiter.length?0:Math.max(...e.record_delimiter.map(e=>e.length)),trimChars:[Buffer.from(" ",e.encoding)[0],Buffer.from("\t",e.encoding)[0]],wasQuoting:!1,wasRowDelimiter:!1,timchars:[Buffer.from(Buffer.from([13],"utf8").toString(),e.encoding),Buffer.from(Buffer.from([10],"utf8").toString(),e.encoding),Buffer.from(Buffer.from([12],"utf8").toString(),e.encoding),Buffer.from(Buffer.from([32],"utf8").toString(),e.encoding),Buffer.from(Buffer.from([9],"utf8").toString(),e.encoding)]}},a=function(e){return e.replace(/([A-Z])/g,function(e,t){return"_"+t.toLowerCase()})},l=function(e){const t={};for(const i in e)t[a(i)]=e[i];if(void 0===t.encoding||!0===t.encoding)t.encoding="utf8";else if(null===t.encoding||!1===t.encoding)t.encoding=null;else if("string"!=typeof t.encoding&&null!==t.encoding)throw new i("CSV_INVALID_OPTION_ENCODING",["Invalid option encoding:","encoding must be a string or null to return a buffer,",`got ${JSON.stringify(t.encoding)}`],t);if(void 0===t.bom||null===t.bom||!1===t.bom)t.bom=!1;else if(!0!==t.bom)throw new i("CSV_INVALID_OPTION_BOM",["Invalid option bom:","bom must be true,",`got ${JSON.stringify(t.bom)}`],t);if(t.cast_function=null,void 0===t.cast||null===t.cast||!1===t.cast||""===t.cast)t.cast=void 0;else if("function"==typeof t.cast)t.cast_function=t.cast,t.cast=!0;else if(!0!==t.cast)throw new i("CSV_INVALID_OPTION_CAST",["Invalid option cast:","cast must be true or a function,",`got ${JSON.stringify(t.cast)}`],t);if(void 0===t.cast_date||null===t.cast_date||!1===t.cast_date||""===t.cast_date)t.cast_date=!1;else if(!0===t.cast_date)t.cast_date=function(e){const t=Date.parse(e);return isNaN(t)?e:new Date(t)};else if("function"!=typeof t.cast_date)throw new i("CSV_INVALID_OPTION_CAST_DATE",["Invalid option cast_date:","cast_date must be true or a function,",`got ${JSON.stringify(t.cast_date)}`],t);if(t.cast_first_line_to_header=void 0,!0===t.columns)t.cast_first_line_to_header=void 0;else if("function"==typeof t.columns)t.cast_first_line_to_header=t.columns,t.columns=!0;else if(Array.isArray(t.columns))t.columns=n(t.columns);else{if(void 0!==t.columns&&null!==t.columns&&!1!==t.columns)throw new i("CSV_INVALID_OPTION_COLUMNS",["Invalid option columns:","expect an array, a function or true,",`got ${JSON.stringify(t.columns)}`],t);t.columns=!1}if(void 0===t.group_columns_by_name||null===t.group_columns_by_name||!1===t.group_columns_by_name)t.group_columns_by_name=!1;else{if(!0!==t.group_columns_by_name)throw new i("CSV_INVALID_OPTION_GROUP_COLUMNS_BY_NAME",["Invalid option group_columns_by_name:","expect an boolean,",`got ${JSON.stringify(t.group_columns_by_name)}`],t);if(!1===t.columns)throw new i("CSV_INVALID_OPTION_GROUP_COLUMNS_BY_NAME",["Invalid option group_columns_by_name:","the `columns` mode must be activated."],t)}if(void 0===t.comment||null===t.comment||!1===t.comment||""===t.comment)t.comment=null;else if("string"==typeof t.comment&&(t.comment=Buffer.from(t.comment,t.encoding)),!Buffer.isBuffer(t.comment))throw new i("CSV_INVALID_OPTION_COMMENT",["Invalid option comment:","comment must be a buffer or a string,",`got ${JSON.stringify(t.comment)}`],t);if(void 0===t.comment_no_infix||null===t.comment_no_infix||!1===t.comment_no_infix)t.comment_no_infix=!1;else if(!0!==t.comment_no_infix)throw new i("CSV_INVALID_OPTION_COMMENT",["Invalid option comment_no_infix:","value must be a boolean,",`got ${JSON.stringify(t.comment_no_infix)}`],t);const r=JSON.stringify(t.delimiter);if(Array.isArray(t.delimiter)||(t.delimiter=[t.delimiter]),0===t.delimiter.length)throw new i("CSV_INVALID_OPTION_DELIMITER",["Invalid option delimiter:","delimiter must be a non empty string or buffer or array of string|buffer,",`got ${r}`],t);if(t.delimiter=t.delimiter.map(function(e){if(null==e||!1===e)return Buffer.from(",",t.encoding);if("string"==typeof e&&(e=Buffer.from(e,t.encoding)),!Buffer.isBuffer(e)||0===e.length)throw new i("CSV_INVALID_OPTION_DELIMITER",["Invalid option delimiter:","delimiter must be a non empty string or buffer or array of string|buffer,",`got ${r}`],t);return e}),void 0===t.escape||!0===t.escape?t.escape=Buffer.from('"',t.encoding):"string"==typeof t.escape?t.escape=Buffer.from(t.escape,t.encoding):null!==t.escape&&!1!==t.escape||(t.escape=null),null!==t.escape&&!Buffer.isBuffer(t.escape))throw new Error(`Invalid Option: escape must be a buffer, a string or a boolean, got ${JSON.stringify(t.escape)}`);if(void 0===t.from||null===t.from)t.from=1;else{if("string"==typeof t.from&&/\d+/.test(t.from)&&(t.from=parseInt(t.from)),!Number.isInteger(t.from))throw new Error(`Invalid Option: from must be an integer, got ${JSON.stringify(t.from)}`);if(t.from<0)throw new Error(`Invalid Option: from must be a positive integer, got ${JSON.stringify(e.from)}`)}if(void 0===t.from_line||null===t.from_line)t.from_line=1;else{if("string"==typeof t.from_line&&/\d+/.test(t.from_line)&&(t.from_line=parseInt(t.from_line)),!Number.isInteger(t.from_line))throw new Error(`Invalid Option: from_line must be an integer, got ${JSON.stringify(e.from_line)}`);if(t.from_line<=0)throw new Error(`Invalid Option: from_line must be a positive integer greater than 0, got ${JSON.stringify(e.from_line)}`)}if(void 0===t.ignore_last_delimiters||null===t.ignore_last_delimiters)t.ignore_last_delimiters=!1;else if("number"==typeof t.ignore_last_delimiters)t.ignore_last_delimiters=Math.floor(t.ignore_last_delimiters),0===t.ignore_last_delimiters&&(t.ignore_last_delimiters=!1);else if("boolean"!=typeof t.ignore_last_delimiters)throw new i("CSV_INVALID_OPTION_IGNORE_LAST_DELIMITERS",["Invalid option `ignore_last_delimiters`:","the value must be a boolean value or an integer,",`got ${JSON.stringify(t.ignore_last_delimiters)}`],t);if(!0===t.ignore_last_delimiters&&!1===t.columns)throw new i("CSV_IGNORE_LAST_DELIMITERS_REQUIRES_COLUMNS",["The option `ignore_last_delimiters`","requires the activation of the `columns` option"],t);if(void 0===t.info||null===t.info||!1===t.info)t.info=!1;else if(!0!==t.info)throw new Error(`Invalid Option: info must be true, got ${JSON.stringify(t.info)}`);if(void 0===t.max_record_size||null===t.max_record_size||!1===t.max_record_size)t.max_record_size=0;else if(Number.isInteger(t.max_record_size)&&t.max_record_size>=0);else{if("string"!=typeof t.max_record_size||!/\d+/.test(t.max_record_size))throw new Error(`Invalid Option: max_record_size must be a positive integer, got ${JSON.stringify(t.max_record_size)}`);t.max_record_size=parseInt(t.max_record_size)}if(void 0===t.objname||null===t.objname||!1===t.objname)t.objname=void 0;else if(Buffer.isBuffer(t.objname)){if(0===t.objname.length)throw new Error("Invalid Option: objname must be a non empty buffer");null===t.encoding||(t.objname=t.objname.toString(t.encoding))}else if("string"==typeof t.objname){if(0===t.objname.length)throw new Error("Invalid Option: objname must be a non empty string")}else if("number"!=typeof t.objname)throw new Error(`Invalid Option: objname must be a string or a buffer, got ${t.objname}`);if(void 0!==t.objname)if("number"==typeof t.objname){if(!1!==t.columns)throw Error("Invalid Option: objname index cannot be combined with columns or be defined as a field")}else if(!1===t.columns)throw Error("Invalid Option: objname field must be combined with columns or be defined as an index");if(void 0===t.on_record||null===t.on_record)t.on_record=void 0;else if("function"!=typeof t.on_record)throw new i("CSV_INVALID_OPTION_ON_RECORD",["Invalid option `on_record`:","expect a function,",`got ${JSON.stringify(t.on_record)}`],t);if(void 0!==t.on_skip&&null!==t.on_skip&&"function"!=typeof t.on_skip)throw new Error(`Invalid Option: on_skip must be a function, got ${JSON.stringify(t.on_skip)}`);if(null===t.quote||!1===t.quote||""===t.quote)t.quote=null;else if(void 0===t.quote||!0===t.quote?t.quote=Buffer.from('"',t.encoding):"string"==typeof t.quote&&(t.quote=Buffer.from(t.quote,t.encoding)),!Buffer.isBuffer(t.quote))throw new Error(`Invalid Option: quote must be a buffer or a string, got ${JSON.stringify(t.quote)}`);if(void 0===t.raw||null===t.raw||!1===t.raw)t.raw=!1;else if(!0!==t.raw)throw new Error(`Invalid Option: raw must be true, got ${JSON.stringify(t.raw)}`);if(void 0===t.record_delimiter)t.record_delimiter=[];else if("string"==typeof t.record_delimiter||Buffer.isBuffer(t.record_delimiter)){if(0===t.record_delimiter.length)throw new i("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a non empty string or buffer,",`got ${JSON.stringify(t.record_delimiter)}`],t);t.record_delimiter=[t.record_delimiter]}else if(!Array.isArray(t.record_delimiter))throw new i("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a string, a buffer or array of string|buffer,",`got ${JSON.stringify(t.record_delimiter)}`],t);if(t.record_delimiter=t.record_delimiter.map(function(e,r){if("string"!=typeof e&&!Buffer.isBuffer(e))throw new i("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a string, a buffer or array of string|buffer",`at index ${r},`,`got ${JSON.stringify(e)}`],t);if(0===e.length)throw new i("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a non empty string or buffer",`at index ${r},`,`got ${JSON.stringify(e)}`],t);return"string"==typeof e&&(e=Buffer.from(e,t.encoding)),e}),"boolean"==typeof t.relax_column_count);else{if(void 0!==t.relax_column_count&&null!==t.relax_column_count)throw new Error(`Invalid Option: relax_column_count must be a boolean, got ${JSON.stringify(t.relax_column_count)}`);t.relax_column_count=!1}if("boolean"==typeof t.relax_column_count_less);else{if(void 0!==t.relax_column_count_less&&null!==t.relax_column_count_less)throw new Error(`Invalid Option: relax_column_count_less must be a boolean, got ${JSON.stringify(t.relax_column_count_less)}`);t.relax_column_count_less=!1}if("boolean"==typeof t.relax_column_count_more);else{if(void 0!==t.relax_column_count_more&&null!==t.relax_column_count_more)throw new Error(`Invalid Option: relax_column_count_more must be a boolean, got ${JSON.stringify(t.relax_column_count_more)}`);t.relax_column_count_more=!1}if("boolean"==typeof t.relax_quotes);else{if(void 0!==t.relax_quotes&&null!==t.relax_quotes)throw new Error(`Invalid Option: relax_quotes must be a boolean, got ${JSON.stringify(t.relax_quotes)}`);t.relax_quotes=!1}if("boolean"==typeof t.skip_empty_lines);else{if(void 0!==t.skip_empty_lines&&null!==t.skip_empty_lines)throw new Error(`Invalid Option: skip_empty_lines must be a boolean, got ${JSON.stringify(t.skip_empty_lines)}`);t.skip_empty_lines=!1}if("boolean"==typeof t.skip_records_with_empty_values);else{if(void 0!==t.skip_records_with_empty_values&&null!==t.skip_records_with_empty_values)throw new Error(`Invalid Option: skip_records_with_empty_values must be a boolean, got ${JSON.stringify(t.skip_records_with_empty_values)}`);t.skip_records_with_empty_values=!1}if("boolean"==typeof t.skip_records_with_error);else{if(void 0!==t.skip_records_with_error&&null!==t.skip_records_with_error)throw new Error(`Invalid Option: skip_records_with_error must be a boolean, got ${JSON.stringify(t.skip_records_with_error)}`);t.skip_records_with_error=!1}if(void 0===t.rtrim||null===t.rtrim||!1===t.rtrim)t.rtrim=!1;else if(!0!==t.rtrim)throw new Error(`Invalid Option: rtrim must be a boolean, got ${JSON.stringify(t.rtrim)}`);if(void 0===t.ltrim||null===t.ltrim||!1===t.ltrim)t.ltrim=!1;else if(!0!==t.ltrim)throw new Error(`Invalid Option: ltrim must be a boolean, got ${JSON.stringify(t.ltrim)}`);if(void 0===t.trim||null===t.trim||!1===t.trim)t.trim=!1;else if(!0!==t.trim)throw new Error(`Invalid Option: trim must be a boolean, got ${JSON.stringify(t.trim)}`);if(!0===t.trim&&!1!==e.ltrim?t.ltrim=!0:!0!==t.ltrim&&(t.ltrim=!1),!0===t.trim&&!1!==e.rtrim?t.rtrim=!0:!0!==t.rtrim&&(t.rtrim=!1),void 0===t.to||null===t.to)t.to=-1;else if(-1!==t.to){if("string"==typeof t.to&&/\d+/.test(t.to)&&(t.to=parseInt(t.to)),!Number.isInteger(t.to))throw new Error(`Invalid Option: to must be an integer, got ${JSON.stringify(e.to)}`);if(t.to<=0)throw new Error(`Invalid Option: to must be a positive integer greater than 0, got ${JSON.stringify(e.to)}`)}if(void 0===t.to_line||null===t.to_line)t.to_line=-1;else if(-1!==t.to_line){if("string"==typeof t.to_line&&/\d+/.test(t.to_line)&&(t.to_line=parseInt(t.to_line)),!Number.isInteger(t.to_line))throw new Error(`Invalid Option: to_line must be an integer, got ${JSON.stringify(e.to_line)}`);if(t.to_line<=0)throw new Error(`Invalid Option: to_line must be a positive integer greater than 0, got ${JSON.stringify(e.to_line)}`)}return t},c=function(e){return e.every(e=>null==e||e.toString&&""===e.toString().trim())},f={utf8:Buffer.from([239,187,191]),utf16le:Buffer.from([255,254])},u=function(e,t={}){"string"==typeof e&&(e=Buffer.from(e));const r=t&&t.objname?{}:[],o=function(e={}){const t=l(e);return{info:{bytes:0,comment_lines:0,empty_lines:0,invalid_field_length:0,lines:1,records:0},original_options:e,options:t,state:s(t),__needMoreData:function(e,t,i){if(i)return!1;const{encoding:r,escape:n,quote:o}=this.options,{quoting:s,needMoreDataSize:a,recordDelimiterMaxLength:l}=this.state;return t-e-1<Math.max(a,0===l?Buffer.from("\r\n",r).length:l,s?(null===n?0:n.length)+o.length:0,s?o.length+l:0)},parse:function(e,t,r,n){const{bom:o,comment_no_infix:s,encoding:a,from_line:c,ltrim:u,max_record_size:_,raw:d,relax_quotes:m,rtrim:h,skip_empty_lines:p,to:g,to_line:b}=this.options;let{comment:w,escape:y,quote:v,record_delimiter:I}=this.options;const{bomSkipped:O,previousBuf:N,rawBuffer:S,escapeIsQuote:E}=this.state;let B;if(void 0===N){if(void 0===e)return void n();B=e}else B=void 0!==N&&void 0===e?N:Buffer.concat([N,e]);if(!1===O)if(!1===o)this.state.bomSkipped=!0;else if(B.length<3){if(!1===t)return void(this.state.previousBuf=B)}else{for(const e in f)if(0===f[e].compare(B,0,f[e].length)){const t=f[e].length;this.state.bufBytesStart+=t,B=B.slice(t);const i=l({...this.original_options,encoding:e});for(const e in i)this.options[e]=i[e];({comment:w,escape:y,quote:v}=this.options);break}this.state.bomSkipped=!0}const C=B.length;let D;for(D=0;D<C&&!this.__needMoreData(D,C,t);D++){if(!0===this.state.wasRowDelimiter&&(this.info.lines++,this.state.wasRowDelimiter=!1),-1!==b&&this.info.lines>b)return this.state.stop=!0,void n();!1===this.state.quoting&&0===I.length&&this.__autoDiscoverRecordDelimiter(B,D)&&(I=this.options.record_delimiter);const e=B[D];if(!0===d&&S.append(e),13!==e&&10!==e||!1!==this.state.wasRowDelimiter||(this.state.wasRowDelimiter=!0),!0===this.state.escaping)this.state.escaping=!1;else{if(null!==y&&!0===this.state.quoting&&this.__isEscape(B,D,e)&&D+y.length<C){if(!E){this.state.escaping=!0,D+=y.length-1;continue}if(this.__isQuote(B,D+y.length)){this.state.escaping=!0,D+=y.length-1;continue}}if(!1===this.state.commenting&&this.__isQuote(B,D))if(!0===this.state.quoting){const t=B[D+v.length],r=h&&this.__isCharTrimable(B,D+v.length),n=null!==w&&this.__compareBytes(w,B,D+v.length,t),o=this.__isDelimiter(B,D+v.length,t),s=0===I.length?this.__autoDiscoverRecordDelimiter(B,D+v.length):this.__isRecordDelimiter(t,B,D+v.length);if(null!==y&&this.__isEscape(B,D,e)&&this.__isQuote(B,D+y.length))D+=y.length-1;else{if(!t||o||s||n||r){this.state.quoting=!1,this.state.wasQuoting=!0,D+=v.length-1;continue}if(!1===m){const e=this.__error(new i("CSV_INVALID_CLOSING_QUOTE",["Invalid Closing Quote:",`got "${String.fromCharCode(t)}"`,`at line ${this.info.lines}`,"instead of delimiter, record delimiter, trimable character","(if activated) or comment"],this.options,this.__infoField()));if(void 0!==e)return e}else this.state.quoting=!1,this.state.wasQuoting=!0,this.state.field.prepend(v),D+=v.length-1}}else{if(0===this.state.field.length){this.state.quoting=!0,D+=v.length-1;continue}if(!1===m){const e=this.__infoField(),t=Object.keys(f).map(e=>!!f[e].equals(this.state.field.toString())&&e).filter(Boolean)[0],r=this.__error(new i("INVALID_OPENING_QUOTE",["Invalid Opening Quote:",`a quote is found on field ${JSON.stringify(e.column)} at line ${e.lines}, value is ${JSON.stringify(this.state.field.toString(a))}`,t?`(${t} bom)`:void 0],this.options,e,{field:this.state.field}));if(void 0!==r)return r}}if(!1===this.state.quoting){const t=this.__isRecordDelimiter(e,B,D);if(0!==t){if(this.state.commenting&&!1===this.state.wasQuoting&&0===this.state.record.length&&0===this.state.field.length)this.info.comment_lines++;else{if(!1===this.state.enabled&&this.info.lines+(!0===this.state.wasRowDelimiter?1:0)>=c){this.state.enabled=!0,this.__resetField(),this.__resetRecord(),D+=t-1;continue}if(!0===p&&!1===this.state.wasQuoting&&0===this.state.record.length&&0===this.state.field.length){this.info.empty_lines++,D+=t-1;continue}this.info.bytes=this.state.bufBytesStart+D;const e=this.__onField();if(void 0!==e)return e;this.info.bytes=this.state.bufBytesStart+D+t;const i=this.__onRecord(r);if(void 0!==i)return i;if(-1!==g&&this.info.records>=g)return this.state.stop=!0,void n()}this.state.commenting=!1,D+=t-1;continue}if(this.state.commenting)continue;if(null!==w&&(!1===s||0===this.state.record.length&&0===this.state.field.length)&&0!==this.__compareBytes(w,B,D,e)){this.state.commenting=!0;continue}const i=this.__isDelimiter(B,D,e);if(0!==i){this.info.bytes=this.state.bufBytesStart+D;const e=this.__onField();if(void 0!==e)return e;D+=i-1;continue}}}if(!1===this.state.commenting&&0!==_&&this.state.record_length+this.state.field.length>_)return this.__error(new i("CSV_MAX_RECORD_SIZE",["Max Record Size:","record exceed the maximum number of tolerated bytes",`of ${_}`,`at line ${this.info.lines}`],this.options,this.__infoField()));const t=!1===u||!0===this.state.quoting||0!==this.state.field.length||!this.__isCharTrimable(B,D),o=!1===h||!1===this.state.wasQuoting;if(!0!==t||!0!==o){if(!0!==h||this.__isCharTrimable(B,D)){!1===t&&(D+=this.__isCharTrimable(B,D)-1);continue}return this.__error(new i("CSV_NON_TRIMABLE_CHAR_AFTER_CLOSING_QUOTE",["Invalid Closing Quote:","found non trimable byte after quote",`at line ${this.info.lines}`],this.options,this.__infoField()))}this.state.field.append(e)}if(!0===t)if(!0===this.state.quoting){const e=this.__error(new i("CSV_QUOTE_NOT_CLOSED",["Quote Not Closed:",`the parsing is finished with an opening quote at line ${this.info.lines}`],this.options,this.__infoField()));if(void 0!==e)return e}else if(!0===this.state.wasQuoting||0!==this.state.record.length||0!==this.state.field.length){this.info.bytes=this.state.bufBytesStart+D;const e=this.__onField();if(void 0!==e)return e;const t=this.__onRecord(r);if(void 0!==t)return t}else!0===this.state.wasRowDelimiter?this.info.empty_lines++:!0===this.state.commenting&&this.info.comment_lines++;else this.state.bufBytesStart+=D,this.state.previousBuf=B.slice(D);!0===this.state.wasRowDelimiter&&(this.info.lines++,this.state.wasRowDelimiter=!1)},__onRecord:function(e){const{columns:t,group_columns_by_name:r,encoding:n,info:o,from:s,relax_column_count:a,relax_column_count_less:l,relax_column_count_more:f,raw:u,skip_records_with_empty_values:_}=this.options,{enabled:d,record:m}=this.state;if(!1===d)return this.__resetRecord();const h=m.length;if(!0===t)return!0===_&&c(m)?void this.__resetRecord():this.__firstLineToColumns(m);if(!1===t&&0===this.info.records&&(this.state.expectedRecordLength=h),h!==this.state.expectedRecordLength){const e=!1===t?new i("CSV_RECORD_INCONSISTENT_FIELDS_LENGTH",["Invalid Record Length:",`expect ${this.state.expectedRecordLength},`,`got ${h} on line ${this.info.lines}`],this.options,this.__infoField(),{record:m}):new i("CSV_RECORD_INCONSISTENT_COLUMNS",["Invalid Record Length:",`columns length is ${t.length},`,`got ${h} on line ${this.info.lines}`],this.options,this.__infoField(),{record:m});if(!0===a||!0===l&&h<this.state.expectedRecordLength||!0===f&&h>this.state.expectedRecordLength)this.info.invalid_field_length++,this.state.error=e;else{const t=this.__error(e);if(t)return t}}if(!0===_&&c(m))this.__resetRecord();else{if(!0===this.state.recordHasError)return this.__resetRecord(),void(this.state.recordHasError=!1);if(this.info.records++,1===s||this.info.records>=s){const{objname:i}=this.options;if(!1!==t){const s={};for(let e=0,i=m.length;e<i;e++)void 0===t[e]||t[e].disabled||(!0===r&&void 0!==s[t[e].name]?Array.isArray(s[t[e].name])?s[t[e].name]=s[t[e].name].concat(m[e]):s[t[e].name]=[s[t[e].name],m[e]]:s[t[e].name]=m[e]);if(!0===u||!0===o){const t=Object.assign({record:s},!0===u?{raw:this.state.rawBuffer.toString(n)}:{},!0===o?{info:this.__infoRecord()}:{}),r=this.__push(void 0===i?t:[s[i],t],e);if(r)return r}else{const t=this.__push(void 0===i?s:[s[i],s],e);if(t)return t}}else if(!0===u||!0===o){const t=Object.assign({record:m},!0===u?{raw:this.state.rawBuffer.toString(n)}:{},!0===o?{info:this.__infoRecord()}:{}),r=this.__push(void 0===i?t:[m[i],t],e);if(r)return r}else{const t=this.__push(void 0===i?m:[m[i],m],e);if(t)return t}}this.__resetRecord()}},__firstLineToColumns:function(e){const{firstLineToHeaders:t}=this.state;try{const r=void 0===t?e:t.call(null,e);if(!Array.isArray(r))return this.__error(new i("CSV_INVALID_COLUMN_MAPPING",["Invalid Column Mapping:","expect an array from column function,",`got ${JSON.stringify(r)}`],this.options,this.__infoField(),{headers:r}));const o=n(r);return this.state.expectedRecordLength=o.length,this.options.columns=o,void this.__resetRecord()}catch(e){return e}},__resetRecord:function(){!0===this.options.raw&&this.state.rawBuffer.reset(),this.state.error=void 0,this.state.record=[],this.state.record_length=0},__onField:function(){const{cast:e,encoding:t,rtrim:i,max_record_size:r}=this.options,{enabled:n,wasQuoting:o}=this.state;if(!1===n)return this.__resetField();let s=this.state.field.toString(t);if(!0===i&&!1===o&&(s=s.trimRight()),!0===e){const[e,t]=this.__cast(s);if(void 0!==e)return e;s=t}this.state.record.push(s),0!==r&&"string"==typeof s&&(this.state.record_length+=s.length),this.__resetField()},__resetField:function(){this.state.field.reset(),this.state.wasQuoting=!1},__push:function(e,t){const{on_record:i}=this.options;if(void 0!==i){const t=this.__infoRecord();try{e=i.call(null,e,t)}catch(e){return e}if(null==e)return}t(e)},__cast:function(e){const{columns:t,relax_column_count:i}=this.options;if(!0===Array.isArray(t)&&i&&this.options.columns.length<=this.state.record.length)return[void 0,void 0];if(null!==this.state.castField)try{const t=this.__infoField();return[void 0,this.state.castField.call(null,e,t)]}catch(e){return[e]}if(this.__isFloat(e))return[void 0,parseFloat(e)];if(!1!==this.options.cast_date){const t=this.__infoField();return[void 0,this.options.cast_date.call(null,e,t)]}return[void 0,e]},__isCharTrimable:function(e,t){return((e,t)=>{const{timchars:i}=this.state;e:for(let r=0;r<i.length;r++){const n=i[r];for(let i=0;i<n.length;i++)if(n[i]!==e[t+i])continue e;return n.length}return 0})(e,t)},__isFloat:function(e){return e-parseFloat(e)+1>=0},__compareBytes:function(e,t,i,r){if(e[0]!==r)return 0;const n=e.length;for(let r=1;r<n;r++)if(e[r]!==t[i+r])return 0;return n},__isDelimiter:function(e,t,i){const{delimiter:r,ignore_last_delimiters:n}=this.options;if(!0===n&&this.state.record.length===this.options.columns.length-1)return 0;if(!1!==n&&"number"==typeof n&&this.state.record.length===n-1)return 0;e:for(let n=0;n<r.length;n++){const o=r[n];if(o[0]===i){for(let i=1;i<o.length;i++)if(o[i]!==e[t+i])continue e;return o.length}}return 0},__isRecordDelimiter:function(e,t,i){const{record_delimiter:r}=this.options,n=r.length;e:for(let o=0;o<n;o++){const n=r[o],s=n.length;if(n[0]===e){for(let e=1;e<s;e++)if(n[e]!==t[i+e])continue e;return n.length}}return 0},__isEscape:function(e,t,i){const{escape:r}=this.options;if(null===r)return!1;const n=r.length;if(r[0]===i){for(let i=0;i<n;i++)if(r[i]!==e[t+i])return!1;return!0}return!1},__isQuote:function(e,t){const{quote:i}=this.options;if(null===i)return!1;const r=i.length;for(let n=0;n<r;n++)if(i[n]!==e[t+n])return!1;return!0},__autoDiscoverRecordDelimiter:function(e,t){const{encoding:i}=this.options,r=[Buffer.from("\r\n",i),Buffer.from("\n",i),Buffer.from("\r",i)];e:for(let i=0;i<r.length;i++){const n=r[i].length;for(let o=0;o<n;o++)if(r[i][o]!==e[t+o])continue e;return this.options.record_delimiter.push(r[i]),this.state.recordDelimiterMaxLength=r[i].length,r[i].length}return 0},__error:function(e){const{encoding:t,raw:i,skip_records_with_error:r}=this.options,n="string"==typeof e?new Error(e):e;if(!r)return n;if(this.state.recordHasError=!0,void 0!==this.options.on_skip)try{this.options.on_skip(n,i?this.state.rawBuffer.toString(t):void 0)}catch(n){return n}},__infoDataSet:function(){return{...this.info,columns:this.options.columns}},__infoRecord:function(){const{columns:e,raw:t,encoding:i}=this.options;return{...this.__infoDataSet(),error:this.state.error,header:!0===e,index:this.state.record.length,raw:t?this.state.rawBuffer.toString(i):void 0}},__infoField:function(){const{columns:e}=this.options,t=Array.isArray(e);return{...this.__infoRecord(),column:!0===t?e.length>this.state.record.length?e[this.state.record.length].name:null:this.state.record.length,quoting:this.state.wasQuoting}}}}(t),a=o.parse(e,!0,e=>{void 0===o.options.objname?r.push(e):r[e[0]]=e[1]},()=>{});if(void 0!==a)throw a;return r};class _{parse(e){try{return u(e,{delimiter:",",columns:e=>e.map(e=>this._mapHeaderToEnglish(e)),skip_empty_lines:!0,trim:!0,cast:(e,t)=>"debit"===t.column||"credit"===t.column||"balance"===t.column?this._parseNumber(e):e}).map(e=>this.parseRow(e)).filter(Boolean)}catch(e){return console.error("Error parsing Afirme file:",e),[]}}_mapHeaderToEnglish(e){return{Concepto:"description","Fecha (DD/MM/AA)":"date",Referencia:"reference",Cargo:"debit",Abono:"credit",Saldo:"balance",Cuenta:"account","Código":"code","No. Secuencia":"sequence"}[e]||e}parseRow(e){if(!e.date||!e.description)return null;const i=this._formatDate(e.date),r=e.debit||0,n=e.credit||0,o=e.balance||0;return new t({date:i,type:0!==n?"credit":"debit",amount:0!==n?n:-r,balance:o,reference:e.reference||"",accountNumber:e.account||"",description:e.description.trim(),bank:"AFIRME",raw:JSON.stringify(e)})}_parseNumber(e){if(!e||""===e.trim())return 0;const t=e.replace(/,/g,"").trim();return parseFloat(t)||0}_formatDate(e){const[t,i,r]=e.split("/");return`${2===r.length?`20${r}`:r}-${i.padStart(2,"0")}-${t.padStart(2,"0")}`}}class d{parse(e){return e.split(/\r?\n/).map(e=>e.trim()).filter(e=>e.length>0).slice(2).map(e=>this.parseRow(e)).filter(Boolean)}parseRow(e){const i=this._splitCsvWithLimit(line,7);if(i.length<8)return null;const[r,n,o,s,a,l,c,f]=i,u=this._formatDateTime(n,o),_=this._parseMoney(l),d=this._parseMoney(c),m=this._parseMoney(f);return new t({date:u,type:0!==d?"credit":"debit",amount:0!==d?d:-_,balance:m,reference:s,accountNumber:null,description:a,bank:"BanBajio",raw:line})}_splitCsvWithLimit(e,t){const i=[];let r=0,n=0;for(let o=0;o<e.length;o++)","===e[o]&&n<t&&(i.push(e.substring(r,o)),r=o+1,n++);return i.push(e.substring(r)),i}_parseMoney(e){return e&&parseFloat(e.replace(/,/g,""))||0}_formatDateTime(e,t){const[i,r,n]=e.split("-");return`${n}-${{Jan:"01",Feb:"02",Mar:"03",Apr:"04",May:"05",Jun:"06",Jul:"07",Aug:"08",Sep:"09",Oct:"10",Nov:"11",Dec:"12"}[r]||"01"}-${i.padStart(2,"0")}T${t}`}}class m{parse(e){try{const t=e.split(/\r?\n/).map(e=>e.trim());let i=-1;for(let e=0;e<t.length;e++)if(t[e].startsWith("Fecha,Descripción,Referencia,Cargo,Abonos,Saldo,Clasificación")){i=e+1;break}if(-1===i)return console.error("Could not find transaction data in Banregio file"),[];const r=t.slice(i).filter(e=>e&&!e.includes("Saldo Inicial")&&!e.includes("Estado de Cuenta")&&e.includes(",")).join("\n"),n=u(r,{delimiter:",",columns:["date","description","reference","debit","credit","balance","classification"],skip_empty_lines:!0,trim:!0,relax_column_count:!0,cast:(e,t)=>"debit"===t.column||"credit"===t.column||"balance"===t.column?this._parseCurrency(e):e}),o=this._extractAccountInfo(t).accountNumber||null;return n.map(e=>this.parseRow(e,o)).filter(Boolean)}catch(e){return console.error("Error parsing Banregio file:",e),[]}}_extractAccountInfo(e){const t={accountNumber:"",clabe:"",accountName:"",rfc:"",address:"",period:""};for(let i=0;i<Math.min(e.length,15);i++){const r=e[i];if(r.includes("CUENTA:")&&(t.accountNumber=r.split("CUENTA:")[1]?.split(",")[0]?.trim()||""),r.includes("CLABE:")&&(t.clabe=r.split("CLABE:")[1]?.split(",")[0]?.trim()||""),r.includes("RFC:")&&(t.rfc=r.split("RFC:")[1]?.split(",")[0]?.trim()||""),r.includes("Fecha inicio:")&&r.includes("Fecha fin:")){const e=r.match(/Fecha inicio:\s*(\d{2}\/\d{2}\/\d{4}).*Fecha fin:\s*(\d{2}\/\d{2}\/\d{4})/);e&&(t.period=`${e[1]} - ${e[2]}`)}3!==i||r.includes(",,,,,")||(t.accountName=r.replace(/,/g,"").trim())}return t}parseRow(e,i){if(!e.date||!e.description)return null;const r=this._formatDate(e.date),n=e.debit||0,o=e.credit||0,s=e.balance||0;return new t({date:r,type:0!==o?"credit":"debit",amount:0!==o?o:-n,balance:s,reference:e.reference||"",accountNumber:i,description:e.description.trim(),bank:"BANREGIO",raw:JSON.stringify(e)})}_parseCurrency(e){if(!e||""===e.trim()||"$0.00"===e||"0.00"===e)return 0;const t=e.replace(/\$/g,"").replace(/,/g,"").trim();return parseFloat(t)||0}_formatDate(e){const[t,i,r]=e.split("/");return`${r}-${i.padStart(2,"0")}-${t.padStart(2,"0")}`}}class h{parse(e){const t=e.split(/\r?\n/).map(e=>e.trim()).filter(e=>e&&!this._isHeader(e));if(0===t.length)return[];const i=e.split(/\r?\n/)[0].trim().split("|").map(e=>e.trim()).map(e=>this._mapHeaderToEnglish(e));return t.map(e=>{const t=e.split("|").map(e=>e.trim()),r={};return i.forEach((e,i)=>{r[e]=t[i]||""}),this.parseRow(r)}).filter(Boolean)}_mapHeaderToEnglish(e){return{Cuenta:"account","Fecha De Operación":"operationDate",Fecha:"date",Referencia:"reference","Descripción":"description","Cod. Transac":"transactionCode",Sucursal:"branch","Depósitos":"deposits",Retiros:"withdrawals",Saldo:"balance",Movimiento:"movement","Descripción Detallada":"detailedDescription",Cheque:"check"}[e]||e}_isHeader(e){return e.includes("Cuenta")&&e.includes("Fecha")&&e.includes("Descripción")}parseRow(e){if(!e.date||!e.description)return null;const i=this._formatDate(e.date),r=this._parseCurrency(e.deposits),n=this._parseCurrency(e.withdrawals),o=this._parseCurrency(e.balance);return new t({date:i,type:0!==r?"credit":"debit",amount:0!==r?r:-n,balance:o,reference:e.reference||"",accountNumber:e.account||"",description:e.description.trim(),bank:"BANORTE",raw:JSON.stringify(e)})}_parseCurrency(e){if(!e||""===e.trim()||"$0.00"===e)return 0;const t=e.replace(/\$/g,"").replace(/,/g,"").trim();return parseFloat(t)||0}_formatDate(e){const[t,i,r]=e.split("/");return`${r}-${i.padStart(2,"0")}-${t.padStart(2,"0")}`}}class p{parse(e){try{return u(e,{delimiter:"\t",columns:e=>e.map(e=>this._mapHeaderToEnglish(e)),skip_empty_lines:!0,trim:!0,cast:(e,t)=>"debit"===t.column||"credit"===t.column||"balance"===t.column?this._parseNumber(e):e}).map(e=>this.parseRow(e)).filter(Boolean)}catch(e){return console.error("Error parsing BBVA file:",e),[]}}_mapHeaderToEnglish(e){return{"Día":"date","Concepto / Referencia":"description",Concepto:"description",cargo:"debit",Abono:"credit",Saldo:"balance"}[e]||e}parseRow(e){if(!e.date||!e.description)return null;const i=this._formatDate(e.date),r=e.debit||0,n=e.credit||0,o=e.balance||0;return new t({date:i,type:0!==n?"credit":"debit",amount:0!==n?n:-r,balance:o,reference:this._extractReference(e.description),accountNumber:"",description:e.description.trim(),bank:"BBVA",raw:JSON.stringify(e)})}_extractReference(e){const t=e.match(/\/(\d{10,})/);return t?t[1]:""}_parseNumber(e){if(!e||""===e.trim())return 0;const t=e.replace(/,/g,"").trim();return parseFloat(t)||0}_formatDate(e){const[t,i,r]=e.split("-");return`${r}-${i.padStart(2,"0")}-${t.padStart(2,"0")}`}}class g{parse(e){const i=e.split("\n").map(e=>e.trim()).filter(e=>e.length>100),r=[];for(const e of i){const i=e.substring(0,3),n=e.substring(3,6),o=e.substring(6,26).replace(/^0+/,""),s=e.substring(28,36);r.push(new t({date:s,type:i,currency:n,reference:null,accountNumber:o,description:"",amount:0,balance:0,bank:"Scotiabank",trackingKey:"",beneficiary:"",extra:e}))}return r}}e.getParserForBank=function(e){switch(e.toLowerCase()){case"afirme":return new _;case"banbajio":return new d;case"banorte":return new h;case"banregio":return new m;case"bbva":return new p;case"scotiabank":return new g;default:throw new Error(`No parser available for bank: ${e}`)}}});
//# sourceMappingURL=index.umd.js.map
